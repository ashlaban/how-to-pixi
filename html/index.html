<html>
<head>
    <title>Hexway's Game of Life</title>

    <link rel="stylesheet" type="text/css" href="../lib/bootstrap.min.css">

    <style>
    body {background-color: #2C5D6F;}
    #main-content {
        padding-left: 50px;
        padding-right: 50px;
        border-radius: 10px;
        background-color: #3C6D7F;
    }
    #side-panel {
        /*padding-left: 50px;
        padding-right: 50px;*/
        border-radius: 10px;
        background-color: #4C7D8F;
    }
    #control-box {
        border-radius: 10px 10px 0px 0px;
        border-width : 1px;
        border-style : solid;
        border-color : #000000;
    }
    #rule-box {
        width: 100%;
        border-radius: 0px 0px 10px 10px;
        border-width : 1px;
        border-style : solid;
        border-color : #000000;

        padding-bottom: 10px;
    }

    .flex-container {    
        display        : flex;
        align-items    : center;
        justify-content: center;
    }

    .vertical {
        flex-direction: column;
    }

    /*.radio-die       {border-radius: 100px; border: 2px solid red;}
    .radio-no-change {border-radius: 100px; border: 2px solid yellow;}
    .radio-live      {border-radius: 100px; border: 2px solid green;}*/

    /*.btn {
        width: 70px;
        height: 25px;
        margin-top   : 5px;
        margin-bottom: 5px;
        margin-left : 2.5px;
        margin-right: 2.5px;
        background-color : #eeeeee;
        border-color     : #eeeeee;
        border-radius: 5px;
    }*/

    #progressbar {
        visibility: hidden;
        width :300px;
    }

    .mirror {
        transform: scale(-1, 1);
    }

    #footer {
        height: 30px;
    }


    </style>
    <script src="../lib/pixi.js"></script>
    <script src="../lib/fpsmeter.min.js"></script>
    <script src="../lib/progressbar.js"></script>

    <script src="../js/HexUtil.js"></script>
    <script src="../js/HexMath.js"></script>
    <script src="../js/HexColor.js"></script>
    <script src="../js/HexCell.js"></script>
    <script src="../js/HexGrid.js"></script>
    <script src="../js/HexLife.js"></script>
</head>
<body>
    <div id='main' class='flex-container vertical'>
    <div id='main-content'>
        <h1 style='margin: 10px 10px 10px 10px;'>Hexway's Game of Life</h1>
        <div class='flex-container'>
            <div id="canvas-wrapper"></div>
            <div id='side-panel' class='flex-container vertical'>
                <div id='control-box' class='flex-container vertical'>
                    <div id='progressbar' class=''></div>
                    <span id='running-indicator' class='btn btn-danger'>Simulation stopped</span>
                    <div class="flex-container btn-group" style='margin-top:10px;'>
                        <input id='btn-step'  class='btn btn-primary' type="button" value="Step">
                        <input id='btn-start' class='btn btn-primary' type="button" value="Start">
                        <input id='btn-stop'  class='btn btn-primary' type="button" value="Stop">
                        <input id='btn-clear' class='btn btn-primary' type="button" value="Clear">
                    </div>
                    <div class="flex-container input-group btn-group" style='margin-bottom:10px;'>
                        <input id='btn-fill'  class='btn btn-primary' type="button" value="Fill">
                        <input id='text-fill' type="text" class='form-control' value="0.5">
                    </div>
                </div>
                <div id='rule-box' class='flex-container vertical'>
                    <h3>Rule configuration</h3>
                    <div class='flex-container'>
                        <div class='flex-container vertical'>
                            0
                            <input type="radio" class="rule radio-die"       name="0" value="0" checked>
                            <input type="radio" class="rule radio-no-change" name="0" value="1" >
                            <input type="radio" class="rule radio-live"      name="0" value="2">
                        </div>
                        <div class='flex-container vertical'>
                            1
                            <input type="radio" class="rule radio-die"       name="1" value="0" checked>
                            <input type="radio" class="rule radio-no-change" name="1" value="1">
                            <input type="radio" class="rule radio-live"      name="1" value="2">
                        </div>
                        <div class='flex-container vertical'>
                            2
                            <input type="radio" class="rule radio-die"       name="2" value="0">
                            <input type="radio" class="rule radio-no-change" name="2" value="1" checked>
                            <input type="radio" class="rule radio-live"      name="2" value="2">
                        </div>
                        <div class='flex-container vertical'>
                            3
                            <input type="radio" class="rule radio-die"       name="3" value="0">
                            <input type="radio" class="rule radio-no-change" name="3" value="1">
                            <input type="radio" class="rule radio-live"      name="3" value="2" checked>
                        </div>
                        <div class='flex-container vertical'>
                            4
                            <input type="radio" class="rule radio-die"       name="4" value="0" checked>
                            <input type="radio" class="rule radio-no-change" name="4" value="1">
                            <input type="radio" class="rule radio-live"      name="4" value="2">
                        </div>
                        <div class='flex-container vertical'>
                            5
                            <input type="radio" class="rule radio-die"       name="5" value="0" checked>
                            <input type="radio" class="rule radio-no-change" name="5" value="1">
                            <input type="radio" class="rule radio-live"      name="5" value="2">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <h2>Explanation</h2>
        <p>This is the classical Game of Life but run on a heaxgonal grid instead of the usual square.</p>
        <div id='footer'></div>
    </div>
    </div>
    <script>

    // Define the hex cell data
    var cos_60 = 0.5
    var sin_60 = 0.86602540378
    var hexPoints = [-1, 0, -cos_60, -sin_60, cos_60, -sin_60, 1,0, cos_60, sin_60, -cos_60, sin_60];
    var hexShape    = new PIXI.Polygon(hexPoints);

    // Seriously!?
    var hexOutlinePoints = hexPoints.map( function(val){return val-0.5;} );
    var hexOutlineShape    = new PIXI.Polygon(hexOutlinePoints);

    function hexesInCanvas () {
        var sizePixels = {
            w: Configuration.view.size.w
                - Configuration.view.padding.left
                - Configuration.view.padding.right,
            h: Configuration.view.size.h
                - Configuration.view.padding.top
                - Configuration.view.padding.bottom
        }
        var hexSide = {
            w: Configuration.grid.scale.x * (2 - 0.5),
            h: Configuration.grid.scale.y * 2 * sin_60
        }
        var w = sizePixels.w/hexSide.w;
        var h = sizePixels.h/hexSide.h;
        return {w:Math.ceil(w), h:Math.ceil(h)};
    }

    // Color information about the grid and board and what not
    var colorPalette = new HexColor.HexPalette( HexColor.pastell, 1 );
    var Configuration = {
        view: {
            size    : { w:320, h:320 },
            padding : {
                        top: 31*sin_60, 
                        right: 16,
                        bottom: 31*sin_60,
                        left: 16
                       },
        },

        grid: {
            lineColor: HexColor.desaturate(HexColor.invertValue(colorPalette.colors[0])),
            lineWidth: 0.1,

            position : {
                            x: 25,
                            y: 40
                        },
            scale    : {x:15, y:15},
            // size     : {w:30, h:20},
            size     : hexesInCanvas
        },
        life: {
            stepsPerSecond: 2,
        },
    };

    // Set up the PIXI renderer
    var renderer = new PIXI.WebGLRenderer   (
                                                Configuration.view.size.w,
                                                Configuration.view.size.h, 
                                                {
                                                    transparent : true,
                                                    antialias   : true
                                                }
                                            );
    document.getElementById('canvas-wrapper').appendChild(renderer.view);

    renderer.view.onmouseup = function(ev) {
        var grid = life.activeGrid;
        // console.log('mouseup')
        // console.log(ev);
        var mousePosition = {x:ev.offsetX,y:ev.offsetY}
        // console.log(mousePosition)
        var offsetCoord = grid._toOffsetCoordinates( mousePosition );
        // console.log('renderer.view.onmouseup - Cube   coordinates', grid._toCubeCoordinates(offsetCoord));
        // console.log('renderer.view.onmouseup - Offset coordinates', grid._toOffsetCoordinates(offsetCoord));
        var cell         = grid.getCell(offsetCoord);
        // cell.color = colorPalette.random();
        
        var circle = HexMath.hexagon(offsetCoord, 0, grid);
        // circle.map( function(val){console.log(val)} );
        // circle.map( function(val){console.log(grid.getCell(val))} );
        circle.map( function(val){grid.getCell(val).highlight();} );
        circle.map( function(val){grid.drawCell(grid.getCell(val));} );

        // cell.highlight();
        // console.log(cell);
        // grid.drawCell(cell);
        grid.renderWith(renderer);
    }
    // renderer.view.onmousemove = function(ev) {
    //     console.log('mousemove');
    //     console.log(ev);
    //     grid._graphics.worldTransform.translate( ev.movementX*100, ev.movementY*100 );
    // }

    var grid = new HexGrid  (
                                Configuration.grid.position,
                                Configuration.grid.size() ,
                                Configuration.grid.scale,
                                colorPalette
                            );
    var grid2 = new HexGrid  (
                                Configuration.grid.position,
                                Configuration.grid.size() ,
                                Configuration.grid.scale,
                                colorPalette
                            );
    // grid = new HexCell({x:100, y:200}, {x:100, y:100}, 0x0000ff);
    grid.draw()
    grid.renderWith(renderer);

    var life = new HexLife.Game(grid, grid2);

    // var meter = new FPSMeter();
    var line  = new ProgressBar.Line('#progressbar', {color: '#EEEEEE', strokeWidth: 2.0});

    // Kick-start the rendering process
    animate();

    function animate() {
        requestAnimationFrame(animate);
        // meter.tick();
        if (life.isStarted) { life.step(Configuration.life.stepsPerSecond); }
    }

    document.getElementById('btn-clear').onclick = function () {
        life.clear();
    };
    document.getElementById('btn-start').onclick = function () {
        document.getElementById('running-indicator').innerHTML = 'Simulation running';
        document.getElementById('running-indicator').className = 'btn btn-success';
        life.start();
    };
    document.getElementById('btn-stop').onclick = function () {
        document.getElementById('running-indicator').innerHTML = 'Simulation stopped';
        document.getElementById('running-indicator').className = 'btn btn-danger';
        life.stop();
    };
    document.getElementById('btn-step').onclick = function () {
        life.step();
    };

    document.getElementById('btn-fill').onclick = function () {
        var fraction = document.getElementById('text-fill').value;
        fraction = Number(fraction);
        life.fillRandom( fraction );
    };

    var radioButtons = document.getElementsByClassName('rule');
    for (var i = 0; i < radioButtons.length; ++i) {
        radioButtons[i].onclick = function () {
            var numNeighbours = Number(this.name);
            var rule          = Number(this.value);
            life.rules[numNeighbours] = rule;
            console.log(life.rules)
        };
    };

    </script>
    </body>
</html>